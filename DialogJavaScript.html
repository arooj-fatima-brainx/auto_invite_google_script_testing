<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
  /**
   * Run initializations on dialog load.
   */
  $(function () {
    addImgaeSource();
    $('#sendTestInvitationButton').click(sendTestInvitation);
    initializeDropdownWithColumnNames();
    $('#completeSetupButton').click(completeSetup);
    $('#dialog-execute-button').click(onExecuteClick);
  });

  /**
   * Calls the server to modify the sheet.
   * Determines the user-specified action (create a sheet, copy the active
   * sheet, clear the active sheet) and asks the server to execute it. The
   * dialog is then closed.
   */
  async function onExecuteClick() {
    let emailsArray = await getData($('#emailAddressColumn').val());
  }

  async function completeSetup() {
    let emailsArray = []
    emailsArray = await getData($('#emailAddressColumn').val());
    var calendarId = $('#calendarId').val();
    var eventId = $('#eventId').val();
    if (!calendarId || !eventId || !emailsArray || emailsArray.length == 0) {
      alert("Please fill required fields");
      return;
    }

    google.script.run.withSuccessHandler(function () {
      alert("Auto Invite setup completed successfully");
    }).withFailureHandler(function (error) {
      alert(error.message);
    }).sendInvitation(calendarId, eventId, emailsArray);
  }

  /**
   * Displays the given status message in the dialog.
   *
   * @param {String} msg The status message to display.
   * @param {String} classId The message type (class id) that the message
   *   should be displayed as.
   */
  function showStatus(msg, classId) {
    $('#dialog-status').removeClass().html(msg);
    if (classId) {
      $('#dialog-status').addClass(classId);
    }
  }

  function initializeDropdownWithColumnNames() {
    var $dropdown = $('#emailAddressColumn');
    JSON.parse(columnNames).forEach(function (name, index) {
      $dropdown.append($('<option>', {
        value: name,
        text: name
      }));
    });
  }

  async function getData(index) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .getColumnData(index);
    });
  }

  function sendTestInvitation() {
    var calendarId = $('#calendarId').val();
    var eventId = $('#eventId').val();
    var testEmail = $('#testEmail').val();
    var testEmailArray = [];
    if (testEmail !== '') {
      testEmailArray.push(testEmail);
    }

    if (!calendarId || !eventId || testEmailArray.length == 0) {
      alert("Please fill required fields");
      return;
    }

    google.script.run.withSuccessHandler(function () {
      alert("Test Invitation sent successfully");
    }).withFailureHandler(function (error) {
      alert(error.message);
    }).sendInvitation(calendarId, eventId, testEmailArray);
  }

  function addImgaeSource() {
    google.script.run.withSuccessHandler(function (base64ImageData) {
      document.getElementById('calendarEventIdExample').src = 'data:image/png;base64,' + base64ImageData;
    }).getBase64ImageData();
  }

  // When the user clicks on the link, open the modal
  document.querySelector('a[href="#eventIdGuideModal"]').addEventListener('click', function (event) {
    event.preventDefault(); // Prevent the default anchor action
    document.getElementById('eventIdGuideModal').style.display = 'block';
  });

  // When the user clicks on <span> (x), close the modal
  document.querySelector('.close').addEventListener('click', function () {
    document.getElementById('eventIdGuideModal').style.display = 'none';
  });

  // Optional: Close the modal if the user clicks anywhere outside of the modal content
  window.onclick = function (event) {
    if (event.target == document.getElementById('eventIdGuideModal')) {
      document.getElementById('eventIdGuideModal').style.display = 'none';
    }
  }
</script>